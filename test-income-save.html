<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Income Save - Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
        }
        input {
            width: 200px;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #1565c0;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <h1>üîç Test Income Save - Debug Tool</h1>

    <div class="test-section">
        <h3>Step 1: Check Backend</h3>
        <button onclick="testBackend()">Test Backend Connection</button>
        <div id="backend-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Check Authentication</h3>
        <button onclick="checkAuth()">Check Token</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Create Transaction</h3>
        <input type="number" id="amount" placeholder="Amount" value="100">
        <input type="text" id="name" placeholder="Name" value="Test Income">
        <input type="date" id="date" value="">
        <br>
        <button onclick="testCreateTransaction()">Test Create Income</button>
        <div id="create-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Verify in Database</h3>
        <button onclick="testGetTransactions()">Get All Transactions</button>
        <div id="get-result" class="result"></div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';

        // Set today's date
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        async function testBackend() {
            const result = document.getElementById('backend-result');
            result.className = 'result info';
            result.textContent = 'Testing...';

            try {
                const response = await fetch('http://127.0.0.1:8000/');
                const data = await response.json();
                result.className = 'result success';
                result.textContent = '‚úÖ Backend is running!\n\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                result.className = 'result error';
                result.textContent = '‚ùå Backend NOT running!\n\nError: ' + error.message + 
                    '\n\nüîß Fix: Start backend server\ncd backend\\backend\npython manage.py runserver';
            }
        }

        function checkAuth() {
            const result = document.getElementById('auth-result');
            const token = localStorage.getItem('authToken');

            if (token) {
                result.className = 'result success';
                result.textContent = '‚úÖ Token found!\n\nToken: ' + token.substring(0, 50) + '...';
            } else {
                result.className = 'result error';
                result.textContent = '‚ùå No token found!\n\nüîß Fix: Please login first\n\n' +
                    'The app should show a login modal. If not, check:\n' +
                    '1. Open app in browser\n' +
                    '2. Login modal should appear\n' +
                    '3. Enter username and password\n' +
                    '4. Click Login';
            }
        }

        async function testCreateTransaction() {
            const amount = document.getElementById('amount').value;
            const name = document.getElementById('name').value;
            const date = document.getElementById('date').value;
            const result = document.getElementById('create-result');

            if (!amount) {
                result.className = 'result error';
                result.textContent = '‚ùå Please enter amount';
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                result.className = 'result error';
                result.textContent = '‚ùå No token! Please login first.';
                return;
            }

            result.className = 'result info';
            result.textContent = 'Creating transaction...';

            const transactionData = {
                type: 'income',
                amount: Number(amount),
                date: date || new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                name: name || '',
                category: '',
                remark: '',
                payment: 'Cash',
                account: 'Cashbook'
            };

            console.log('Sending:', transactionData);

            try {
                const response = await fetch(`${API_URL}/transactions/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transactionData),
                });

                console.log('Response status:', response.status);

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    result.className = 'result error';
                    result.textContent = `‚ùå Invalid response\n\nStatus: ${response.status}\nResponse: ${text}`;
                    return;
                }

                if (response.ok) {
                    result.className = 'result success';
                    result.textContent = '‚úÖ Transaction created successfully!\n\n' + 
                        JSON.stringify(data, null, 2) + '\n\n‚úÖ Data saved to database!';
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Failed to create transaction!\n\nStatus: ${response.status}\n\nResponse:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = '‚ùå Network Error!\n\n' + error.message + '\n\n' +
                    'Possible issues:\n' +
                    '1. Backend not running\n' +
                    '2. Wrong API URL\n' +
                    '3. CORS error\n' +
                    '4. Network connection problem';
                console.error('Error:', error);
            }
        }

        async function testGetTransactions() {
            const result = document.getElementById('get-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                result.className = 'result error';
                result.textContent = '‚ùå No token! Please login first.';
                return;
            }

            result.className = 'result info';
            result.textContent = 'Fetching transactions...';

            try {
                const response = await fetch(`${API_URL}/transactions/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Found ${data.length || 0} transactions\n\n` + 
                        JSON.stringify(data, null, 2);
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Failed!\n\nStatus: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = '‚ùå Error: ' + error.message;
            }
        }
    </script>
</body>
</html>

